# 実装計画

- [ ] 1. プロジェクト構造とローカル開発環境の構築
  - プロジェクトディレクトリ構造の作成
  - pyproject.toml、requirements.txt、.env.exampleの設定
  - Python仮想環境（venv）のセットアップスクリプト作成
  - ローカル実行用main.pyの作成
  - 基本的な設定管理クラスを実装（ローカル/AWS両対応）
  - 開発用Makefileまたはスクリプトの作成
  - _要件: 4.1, 4.2_

- [ ] 2. データモデルとバリデーションの実装
- [ ] 2.1 コアデータモデルの作成
  - StockData、StockConfig、WatchlistStock、Portfolioクラスを実装
  - GoogleSheetsConfigクラスを追加
  - データクラスとバリデーション機能を追加
  - _要件: 1.4, 1.1, 2.3_

- [ ] 2.2 分析結果モデルの実装
  - AnalysisResult、Recommendation、RiskAssessmentクラスを作成
  - AnalysisType、TechnicalIndicatorsクラスを追加
  - Enumクラスで推奨タイプとリスクレベルを定義
  - _要件: 2.5, 2.1, 2.2, 2.3_

- [ ] 3. AWS統合とユーティリティの実装
- [ ] 3.1 AWS Parameter Store統合
  - Parameter Storeから設定を読み込むConfigManagerを実装
  - Google Sheets設定とAPI認証情報の管理
  - 設定の検証とデフォルト値処理を追加
  - _要件: 4.1, 4.4, 1.1_

- [ ] 3.3 Google Sheets統合サービス
  - Google Sheets APIクライアントの実装
  - 保有銘柄シートからのデータ取得機能
  - ウォッチリストシートからのデータ取得機能
  - シート構造の検証機能
  - _要件: 1.1_

- [ ] 3.2 CloudWatchログとメトリクス統合
  - 構造化ログ機能を実装
  - カスタムメトリクス送信機能を追加
  - _要件: 6.1, 6.2_

- [ ] 4. 株式データ取得サービスの実装
- [ ] 4.1 株式データAPIクライアントの作成
  - Yahoo Finance APIまたはAlpha Vantage APIとの統合
  - Google Sheetsから取得した銘柄リストに基づくデータ取得
  - データ取得とパースロジックを実装
  - _要件: 1.1, 1.2_

- [ ] 4.2 履歴データ取得機能
  - テクニカル分析用の履歴データ取得機能を実装
  - 価格履歴と出来高履歴の管理
  - _要件: 2.1_

- [ ] 4.3 データ検証と正規化機能
  - 取得データの妥当性チェック機能を実装
  - エラーハンドリングと部分的失敗への対応
  - _要件: 1.3, 1.4_

- [ ] 4.4 リトライ機能とレート制限対応
  - 指数バックオフによるリトライ機能を実装
  - API制限に対応するレート制限機能を追加
  - _要件: 1.3_

- [ ] 4.5 テクニカル指標計算サービスの実装
  - 移動平均線、RSI、MACD等の計算機能を実装
  - ゴールデンクロス/デッドクロス検出機能
  - 新高値/新安値ブレイク検出機能
  - サポート・レジスタンス計算機能
  - 市場相関係数と出来高変化率の計算
  - _要件: 2.1_

- [ ] 5. Gemini AI分析サービスの実装
- [ ] 5.1 Gemini APIクライアントの作成
  - Google Gemini APIとの統合
  - 認証とリクエスト送信機能を実装
  - _要件: 2.1, 2.2_

- [ ] 5.2 日次分析機能の実装
  - テクニカル指標に基づく日次分析ロジック
  - 保有銘柄の売買推奨機能（追加購入・売却アドバイス）
  - ウォッチリスト銘柄の購入推奨機能
  - 保有銘柄とウォッチリストの区別した分析処理
  - _要件: 2.1_

- [ ] 5.3 週次分析機能の実装
  - 保有株式のパフォーマンス分析機能
  - 週間リターンとボラティリティ計算
  - ベンチマーク比較機能
  - _要件: 2.2_

- [ ] 5.4 月次分析機能の実装
  - 国別・業種別パフォーマンス分析
  - 長期リバランスアドバイス機能
  - 分散投資状況の評価
  - _要件: 2.3_

- [ ] 5.5 分析プロンプト生成機能
  - 分析タイプ別のプロンプト生成
  - テクニカル指標を含むプロンプト作成
  - ポートフォリオコンテキストの統合
  - _要件: 2.1, 2.2, 2.3_

- [ ] 5.6 分析結果の構造化処理
  - Gemini APIレスポンスのパースと構造化
  - 分析結果の検証と正規化
  - _要件: 2.5_

- [ ] 5.7 AI分析のエラーハンドリング
  - API呼び出し失敗時のリトライ機能
  - 分析結果の品質チェック機能
  - _要件: 2.4_

- [ ] 6. Slack通知サービスの実装
- [ ] 6.1 Slack Webhook統合
  - Slack Webhook APIとの統合
  - メッセージ送信機能を実装
  - _要件: 3.1, 3.4_

- [ ] 6.2 通知メッセージフォーマット機能
  - 分析結果をSlackメッセージ形式に変換
  - リッチフォーマット（ブロック、添付ファイル）のサポート
  - _要件: 3.2_

- [ ] 6.3 通知エラーハンドリング
  - 送信失敗時のリトライ機能
  - エラー通知機能の実装
  - _要件: 3.3_

- [ ] 6.4 緊急度別通知機能
  - 重要な分析結果の特別フォーマット
  - 通知の優先度管理機能
  - _要件: 3.5_

- [ ] 7. Lambda関数メインハンドラーの実装
- [ ] 7.1 Lambda関数エントリーポイント
  - lambda_handlerメイン関数を実装
  - Event Bridgeイベントの処理（分析タイプ判定）
  - 日次・週次・月次スケジュールの管理
  - _要件: 5.1, 5.2, 5.3, 5.4_

- [ ] 7.2 サービス統合とワークフロー
  - 各サービスを統合したメイン処理フローを実装
  - エラーハンドリングと復旧機能
  - _要件: 5.4_

- [ ] 7.3 実行時間とメモリ最適化
  - Lambda関数の実行時間最適化
  - メモリ使用量の監視と最適化
  - _要件: 6.1_

- [ ] 8. エラーハンドリングとロバストネス
- [ ] 8.1 包括的エラーハンドリング
  - ErrorHandlerクラスの実装
  - エラータイプ別の処理戦略
  - _要件: 6.2, 6.4_

- [ ] 8.2 リトライポリシーの実装
  - RetryPolicyクラスの作成
  - 指数バックオフアルゴリズムの実装
  - _要件: 1.3, 2.4, 3.3_

- [ ] 9. テストスイートの実装
- [ ] 9.1 単体テストの作成
  - 各サービスクラスのpytestテストを作成
  - モックを使用した外部API依存の分離
  - _要件: 全要件のテストカバレッジ_

- [ ] 9.2 統合テストの実装
  - エンドツーエンドワークフローのテスト
  - AWS サービス統合のテスト
  - _要件: 全要件の統合テスト_

- [ ] 9.3 テスト環境とモックの設定
  - テスト用設定とモックAPIの作成
  - CI/CDパイプライン用のテスト設定
  - _要件: テスト環境の要件_

- [ ] 10. デプロイメント設定とインフラ
- [ ] 10.1 AWS SAMテンプレートの作成
  - Lambda関数、Event Bridge（3つのスケジュール）、Parameter Storeの定義
  - IAMロールと権限の設定（Google Sheets API権限を含む）
  - 日次・週次・月次の異なるEvent Bridgeルールの設定
  - Google Sheets API認証情報の安全な管理設定
  - _要件: 5.1, 5.2, 5.3, 5.4, 4.1, 1.1_

- [ ] 10.2 デプロイメントスクリプト
  - 自動デプロイメント用のスクリプト作成
  - 環境別設定の管理
  - _要件: 運用要件_

- [ ] 10.3 GitHub Actions CI/CDパイプラインの設定
  - .github/workflows/deploy.ymlワークフローファイルの作成
  - テスト、リンティング、カバレッジ測定の設定
  - ステージング・本番環境への自動デプロイ設定
  - GitHub Secretsでの認証情報管理
  - Slack通知の設定
  - _要件: 運用要件_

- [ ] 10.4 監視とアラートの設定
  - CloudWatchアラームの設定
  - ダッシュボードの作成
  - デプロイ通知の設定
  - _要件: 6.1, 6.2_